# 調整コンパスアプリ 設計書

## 1. システムアーキテクチャ

### 1.1 アーキテクチャパターン
- **MVVM（Model-View-ViewModel）パターン**を採用
- Android Architecture Components（LiveData、ViewModel）を使用

### 1.2 レイヤー構成

```
┌─────────────────────────────────┐
│         UI Layer                │
│  (Activity, Fragment, Views)    │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│      ViewModel Layer            │
│  (CompassViewModel)             │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│      Repository Layer            │
│  (CompassRepository)             │
│  (SettingsRepository)            │
└──────────────┬──────────────────┘
               │
┌──────────────▼──────────────────┐
│      Data Layer                  │
│  (SensorManager, SharedPrefs)    │
└──────────────────────────────────┘
```

## 2. クラス設計

### 2.1 主要クラス

#### 2.1.1 CompassActivity
- **責務**: UIの表示とユーザー操作の処理
- **依存**: CompassViewModel
- **主要メソッド**:
  - `onCreate()`: 初期化
  - `onSensorChanged()`: センサー値の受信
  - `onResume()`/`onPause()`: センサーの登録/解除

#### 2.1.2 CompassViewModel
- **責務**: ビジネスロジックの処理、UI状態の管理
- **依存**: CompassRepository, SettingsRepository
- **主要プロパティ**:
  - `azimuth: LiveData<Float>`: 現在の方位角
  - `offsetAngle: LiveData<Float>`: オフセット角度
  - `isAdjustmentMode: LiveData<Boolean>`: 調整モード状態
  - `isLocked: LiveData<Boolean>`: ロック状態
- **主要メソッド**:
  - `startCompass()`: コンパス開始
  - `stopCompass()`: コンパス停止
  - `enterAdjustmentMode()`: 調整モードに入る
  - `setOffset(angle: Float)`: オフセット設定
  - `lockOffset()`: オフセットをロック
  - `unlockOffset()`: ロック解除
  - `resetOffset()`: オフセットリセット

#### 2.1.3 CompassRepository
- **責務**: センサーからの方位データ取得
- **依存**: SensorManager
- **主要メソッド**:
  - `getAzimuth(): Flow<Float>`: 方位角のFlow
  - `isSensorAvailable(): Boolean`: センサー利用可能性チェック

#### 2.1.4 SettingsRepository
- **責務**: オフセットとロック状態の永続化
- **依存**: SharedPreferences
- **主要メソッド**:
  - `saveOffset(angle: Float)`: オフセット保存
  - `loadOffset(): Float`: オフセット読み込み
  - `saveLockState(isLocked: Boolean)`: ロック状態保存
  - `loadLockState(): Boolean`: ロック状態読み込み

#### 2.1.5 CompassView (カスタムView)
- **責務**: コンパスの視覚的表示
- **主要メソッド**:
  - `setAzimuth(angle: Float)`: 方位角を設定して描画
  - `setOffset(angle: Float)`: オフセットを設定

## 3. データフロー

### 3.1 コンパス表示のフロー

```
SensorManager
    ↓
CompassRepository (方位計算)
    ↓
CompassViewModel (オフセット適用)
    ↓
LiveData<Float> (azimuth)
    ↓
CompassActivity (UI更新)
    ↓
CompassView (描画)
```

### 3.2 オフセット調整のフロー

```
ユーザー操作 (調整ボタン)
    ↓
CompassViewModel.enterAdjustmentMode()
    ↓
ユーザー操作 (画面回転)
    ↓
CompassViewModel.setOffset(angle)
    ↓
ユーザー操作 (ロックボタン)
    ↓
CompassViewModel.lockOffset()
    ↓
SettingsRepository.saveOffset()
    ↓
SharedPreferences (永続化)
```

## 4. UI設計

### 4.1 デザインコンセプト

- **シンプルでモダン**: Material Design 3の原則に基づく
- **ミニマル**: 必要最小限の要素のみを表示
- **視認性**: コントラストを重視した配色
- **直感的**: アイコンとテキストで操作を明確化

### 4.2 レイアウト構成

```
CompassActivity
└── ConstraintLayout (root)
    ├── CompassView (中央、最大サイズ、円形)
    ├── TextView (方位角表示 - 上部中央)
    ├── Chip (オフセット表示 - 調整モード時のみ表示)
    └── BottomAppBar (下部固定)
        ├── IconButton (調整)
        ├── IconButton (ロック/ロック解除)
        └── IconButton (リセット)
```

### 4.3 カラースキーム（Material Design 3）

- **プライマリカラー**: 深い青（#1976D2）またはシステムテーマカラー
- **セカンダリカラー**: アクセントカラー（#FF6B6B）
- **背景色**: 
  - ライトモード: #FFFFFF
  - ダークモード: #121212
- **テキスト色**:
  - ライトモード: #212121
  - ダークモード: #FFFFFF
- **調整モード背景**: 薄いアクセント色（透明度20%）

### 4.4 CompassViewの設計

#### 4.4.1 視覚的要素

- **形状**: 完全な円形
- **サイズ**: 画面幅の80%程度（最大600dp）
- **背景**: 透明または薄いグレー（#F5F5F5 / ダーク: #1E1E1E）
- **要素**:
  1. **外側リング**: 細い線（2dp）、グレー（#BDBDBD）
  2. **方位マーカー**: N, E, S, W を大きく表示
     - N: 赤色（#F44336）で強調
     - E, S, W: グレー（#757575）
  3. **中間リング**: 45度ごとのマーカー（細い線）
  4. **中央ローズ**: シンプルな矢印（N方向を指す）
     - 色: プライマリカラー
     - 形状: 三角形の矢印
  5. **現在方位インジケーター**: 上部に固定されたマーカー（▼）

#### 4.4.2 アニメーション

- **回転**: `ObjectAnimator`を使用した滑らかな回転
- **補間**: `AccelerateDecelerateInterpolator`で自然な動き
- **更新頻度**: 60fpsを維持

### 4.5 コンポーネント設計

#### 4.5.1 方位角表示（TextView）

- **位置**: 画面上部中央
- **スタイル**: 
  - フォントサイズ: 24sp（大）、18sp（小）
  - フォントウェイト: Medium
  - 形式: "方位: 045°" または "045°"
- **背景**: なし（透明）

#### 4.5.2 オフセット表示（Chip）

- **表示条件**: 調整モード時のみ
- **位置**: 方位角表示の下
- **スタイル**: Material Chip（Outlined）
- **内容**: "オフセット: +15°" または "-15°"
- **色**: アクセントカラー

#### 4.5.3 ボタン（BottomAppBar）

- **配置**: 画面下部中央に横並び
- **スタイル**: Material IconButton（Filled Tonal）
- **サイズ**: 56dp × 56dp
- **アイコン**:
  - 調整: `edit` または `tune`
  - ロック: `lock` / `lock_open`
  - リセット: `refresh` または `restart_alt`
- **間隔**: 16dp
- **背景**: 半透明の白/黒（Blur効果）

### 4.6 状態表示

#### 4.6.1 通常モード

- **背景**: 標準背景色
- **コンパス**: 通常の色で表示
- **ボタン**: 通常の状態

#### 4.6.2 調整モード

- **背景**: 薄いアクセント色のオーバーレイ（透明度10-20%）
- **コンパス**: 少し薄く表示（透明度90%）
- **オフセット表示**: 表示される
- **調整ボタン**: アクティブ状態（色が変わる）

#### 4.6.3 ロック状態

- **ロックボタン**: 
  - アイコン: `lock`（閉じた錠）
  - 色: アクセントカラーで強調
- **その他のボタン**: 無効化（調整、リセット）
- **視覚的フィードバック**: 小さなバッジまたはアニメーション

### 4.7 タイポグラフィ

- **フォントファミリー**: Roboto（システムデフォルト）
- **方位角**: 24sp, Medium
- **方位ラベル（N, E, S, W）**: 20sp, Bold
- **オフセット**: 14sp, Regular
- **ボタンラベル**: 12sp, Medium（必要に応じて）

### 4.8 スペーシング

- **画面マージン**: 16dp（左右）、24dp（上下）
- **コンポーネント間隔**: 16dp
- **ボタン間隔**: 16dp
- **コンパスとテキストの間隔**: 24dp

### 4.9 ダークモード対応

- **自動切り替え**: システム設定に従う
- **色の調整**: すべての色をダークモード用に調整
- **コントラスト**: WCAG AA基準を満たす

### 4.10 レスポンシブデザイン

- **タブレット**: コンパスサイズを最大800dpに制限
- **ランドスケープ**: レイアウトを調整（必要に応じて）
- **小さい画面**: コンパスサイズを自動調整

## 5. データ設計

### 5.1 SharedPreferences データ構造

```kotlin
// キー定義
object CompassPrefs {
    const val PREF_NAME = "compass_prefs"
    const val KEY_OFFSET_ANGLE = "offset_angle"      // Float
    const val KEY_IS_LOCKED = "is_locked"            // Boolean
}

// データ例
{
    "offset_angle": 15.5,  // 度単位
    "is_locked": true
}
```

### 5.2 センサーデータ

```kotlin
// センサー値の保持
private var accelerometerData: FloatArray? = null
private var magneticData: FloatArray? = null

// 計算結果
private val rotationMatrix = FloatArray(9)
private val orientationAngles = FloatArray(3)
```

## 6. アルゴリズム設計

### 6.1 方位計算アルゴリズム

```kotlin
fun calculateAzimuth(): Float {
    // 1. 回転行列を計算
    SensorManager.getRotationMatrix(
        rotationMatrix, null,
        accelerometerData, magneticData
    )
    
    // 2. 方位角を取得
    SensorManager.getOrientation(rotationMatrix, orientationAngles)
    val azimuth = Math.toDegrees(orientationAngles[0].toDouble()).toFloat()
    
    // 3. 0-360度に正規化
    val normalizedAzimuth = if (azimuth < 0) azimuth + 360 else azimuth
    
    // 4. オフセットを適用
    val adjustedAzimuth = (normalizedAzimuth + offsetAngle) % 360
    
    return adjustedAzimuth
}
```

### 6.2 オフセット調整アルゴリズム

```kotlin
fun calculateOffset(currentAzimuth: Float, targetAzimuth: Float): Float {
    // 目標方位と現在方位の差を計算
    var offset = targetAzimuth - currentAzimuth
    
    // -180から180度の範囲に正規化
    if (offset > 180) offset -= 360
    if (offset < -180) offset += 360
    
    return offset
}
```

## 7. 技術スタック

### 7.1 使用ライブラリ

- **AndroidX Core**: 基本機能
- **AndroidX Lifecycle**: ViewModel, LiveData
- **Kotlin Coroutines**: 非同期処理
- **Kotlin Flow**: リアクティブストリーム（オプション）

### 7.2 開発環境

- **言語**: Kotlin
- **最小SDK**: API Level 21 (Android 5.0)
- **ターゲットSDK**: API Level 34 (Android 14)
- **ビルドツール**: Gradle

## 8. エラーハンドリング

### 8.1 エラーケース

1. **センサーが利用できない場合**
   - エラーメッセージを表示
   - アプリは起動するが、コンパスは動作しない

2. **センサー値が取得できない場合**
   - 警告メッセージを表示
   - 最後の有効な値を保持

3. **設定の読み込み失敗**
   - デフォルト値（オフセット0、ロック解除）を使用

## 9. テスト設計

### 9.1 単体テスト

- CompassViewModelのテスト
- SettingsRepositoryのテスト
- 方位計算ロジックのテスト

### 9.2 UIテスト

- ボタン操作のテスト
- 状態遷移のテスト

## 10. パフォーマンス最適化

### 10.1 センサー更新頻度

- デフォルト: `SensorManager.SENSOR_DELAY_UI` (約60ms間隔)
- 必要に応じて調整可能

### 10.2 UI更新

- ViewModelのLiveDataを使用して必要な時のみ更新
- CompassViewの再描画は`invalidate()`で最適化

